<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechDaily - Secure Downloads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f3f4f6; color: #1f2937; font-family: 'Segoe UI', sans-serif; }
        .card-box { background: #ffffff; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 12px; }
        .loader { border: 3px solid #e5e7eb; border-top: 3px solid #2563eb; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ad-container { min-height: 250px; background: #f9fafb; border: 1px dashed #cbd5e1; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin: 15px 0; overflow: hidden; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-newspaper text-blue-600 text-2xl mr-2"></i>
                <span class="font-bold text-xl text-gray-800">Tech<span class="text-blue-600">Daily</span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 flex-grow">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- LEFT COLUMN -->
            <div class="lg:col-span-2 space-y-8">
                <div id="download-section" class="card-box p-6 relative">
                    <div class="border-b border-gray-100 pb-4 mb-4 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-gray-800">Secure File Download</h2>
                        <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">Verified</span>
                    </div>

                    <!-- Loading -->
                    <div id="loading-ui" class="flex flex-col items-center py-10">
                        <div class="loader mb-4"></div>
                        <p class="text-gray-500 text-sm">Initializing connection...</p>
                    </div>

                    <!-- Error -->
                    <div id="error-ui" class="hidden text-center py-10">
                        <h3 class="font-bold text-red-500">Link Expired</h3>
                    </div>

                    <!-- Active Content -->
                    <div id="content-ui" class="hidden">
                        <!-- Progress -->
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 5%"></div>
                        </div>

                        <!-- Step 1 -->
                        <div id="step-1" class="fade-in">
                            <p class="text-sm text-gray-600 mb-2">Step 1: Verification</p>
                            <!-- Ad Slot 1 (Banner Ad) -->
                            <div class="ad-container">
                                <div id="ad-slot-1" class="w-full flex justify-center"></div>
                            </div>
                            <div class="flex justify-between items-center mt-4 bg-gray-50 p-4 rounded-lg">
                                <span class="text-gray-600 text-sm">Wait time:</span>
                                <div class="flex items-center gap-4">
                                    <span id="timer-1" class="text-2xl font-bold text-blue-600">10s</span>
                                    <button id="btn-1" class="px-6 py-2 bg-gray-300 text-gray-500 rounded font-bold text-sm" disabled>Next</button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2 -->
                        <div id="step-2" class="hidden">
                            <p class="text-sm text-gray-600 mb-2">Step 2: Security Check</p>
                            <!-- Ad Slot 2 (Script Ad) -->
                            <div class="ad-container">
                                <div id="ad-slot-2" class="w-full flex justify-center"></div>
                            </div>
                            <div class="flex justify-between items-center mt-4 bg-gray-50 p-4 rounded-lg">
                                <span class="text-gray-600 text-sm">Finalizing:</span>
                                <div class="flex items-center gap-4">
                                    <span id="timer-2" class="text-2xl font-bold text-blue-600">10s</span>
                                    <button id="btn-2" class="px-6 py-2 bg-gray-300 text-gray-500 rounded font-bold text-sm" disabled>Continue</button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3 -->
                        <div id="step-3" class="hidden text-center">
                            <div class="bg-green-50 border border-green-100 rounded-lg p-6 mb-4">
                                <i class="fas fa-check-circle text-green-500 text-4xl mb-2"></i>
                                <h3 class="text-lg font-bold text-gray-800">File Ready</h3>
                            </div>
                            <!-- Ad Slot 3 (Final Script) -->
                            <div id="ad-slot-final" class="mb-4"></div>
                            
                            <button id="btn-final" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg">
                                <i class="fas fa-download mr-2"></i> Download Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN (Sidebar) -->
            <div class="lg:col-span-1">
                <div class="card-box p-6">
                    <h4 class="font-bold text-gray-800 mb-4">Trending</h4>
                    <ul class="space-y-4 text-sm text-gray-600">
                        <li>üî• Top Games 2024</li>
                        <li>‚ö° Android Utilities</li>
                        <li>üõ°Ô∏è Security Updates</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAcVc5Dw6dwAS22N181QQE5kTt-qxhPXbg",
            authDomain: "link-nahidx07.firebaseapp.com",
            projectId: "link-nahidx07",
            storageBucket: "link-nahidx07.firebasestorage.app",
            messagingSenderId: "190047560233",
            appId: "1:190047560233:web:0aef70355004143c063238"
        };
        // ---------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- HARDCODED ADS (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶ï‡ßã‡¶°‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ñ‡¶æ‡¶®‡ßá) ---
        const ADS = {
            // Step 1: Banner/Container Ad
            step1: `
                <script async="async" data-cfasync="false" src="https://pl28783600.effectivegatecpm.com/0602e13aa7413f2509f38ec033109d60/invoke.js"><\/script>
                <div id="container-0602e13aa7413f2509f38ec033109d60"></div>
            `,
            // Step 2: First Script Ad
            step2: `
                <script src="https://pl28783603.effectivegatecpm.com/b6/45/11/b6451102b06e9ac0648d885ceb7cdca3.js"><\/script>
            `,
            // Step 3: Second Script Ad
            final: `
                <script src="https://pl28783590.effectivegatecpm.com/13/75/be/1375be13428ae9984ea517804752bb57.js"><\/script>
            `,
            // Direct Link (Pop-under)
            directLink: "https://www.effectivegatecpm.com/jxktji2ys?key=7aa78c181a84de4b30cd2fd87cf6c1de"
        };

        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('id');
        const loadingUi = document.getElementById('loading-ui');
        const contentUi = document.getElementById('content-ui');
        const errorUi = document.getElementById('error-ui');
        const progressBar = document.getElementById('progress-bar');
        let linkData = null;

        async function init() {
            if (!slug) { showError(); return; }
            try {
                const docRef = doc(db, "links", slug);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    linkData = docSnap.data();
                    setupStep1();
                } else { showError(); }
            } catch (err) { showError(); }
        }

        function showError() {
            loadingUi.classList.add('hidden');
            errorUi.classList.remove('hidden');
        }

        function injectAd(elementId, htmlContent) {
            const container = document.getElementById(elementId);
            container.innerHTML = htmlContent;
            const scripts = container.getElementsByTagName("script");
            for (let i = 0; i < scripts.length; i++) {
                const s = document.createElement("script");
                if (scripts[i].src) s.src = scripts[i].src;
                else s.innerHTML = scripts[i].innerHTML;
                document.head.appendChild(s);
            }
        }

        function setupStep1() {
            loadingUi.classList.add('hidden');
            contentUi.classList.remove('hidden');
            
            // Inject Ad 1
            injectAd('ad-slot-1', ADS.step1);

            let timeLeft = 10;
            const timerEl = document.getElementById('timer-1');
            const btnEl = document.getElementById('btn-1');
            const interval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft + 's';
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    timerEl.classList.add('hidden');
                    btnEl.disabled = false;
                    btnEl.classList.add('bg-blue-600', 'text-white');
                    btnEl.addEventListener('click', setupStep2);
                }
            }, 1000);
        }

        function setupStep2() {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            progressBar.style.width = "50%";

            // Inject Ad 2
            injectAd('ad-slot-2', ADS.step2);

            let timeLeft = 10;
            const timerEl = document.getElementById('timer-2');
            const btnEl = document.getElementById('btn-2');
            const interval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft + 's';
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    timerEl.classList.add('hidden');
                    btnEl.disabled = false;
                    btnEl.classList.add('bg-blue-600', 'text-white');
                    btnEl.addEventListener('click', setupStep3);
                }
            }, 1000);
        }

        function setupStep3() {
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.remove('hidden');
            progressBar.style.width = "100%";

            // Inject Ad 3
            injectAd('ad-slot-final', ADS.final);

            const btn = document.getElementById('btn-final');
            btn.addEventListener('click', async () => {
                // 1. Open Direct Link Ad in New Tab
                window.open(ADS.directLink, '_blank');

                // 2. Update Stats & Redirect Main Tab
                btn.innerHTML = 'Downloading...';
                try {
                    const docRef = doc(db, "links", slug);
                    await updateDoc(docRef, { clicks: increment(1) });
                } catch (e) {}
                
                // Redirect to original file
                window.location.href = linkData.original_url;
            });
        }

        init();
    </script>
</body>
</html>
